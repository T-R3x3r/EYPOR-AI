# Query-Specific File Generation Tracking

## Overview

This implementation adds query-specific file generation tracking to ensure that only files created during the current query are displayed in the "Generated Files" window. This prevents the system from showing files from previous queries or unrelated executions.

## Problem Solved

Previously, the "Generated Files" window would show all files in the temporary directory, including files created during previous queries. This was confusing because:

1. **Unrelated files appeared**: Files from previous queries would show up even for unrelated new queries
2. **No clear context**: Users couldn't tell which files were actually generated by their current request
3. **Accumulation over time**: The file list would grow indefinitely with each query

## Solution Implementation

### Backend Changes

#### 1. Global Query Tracking (`main.py`)

**Added global variable:**
```python
query_start_time = None  # Track when each query starts
```

**Modified `langgraph_chat` endpoint:**
- Sets `query_start_time = time.time()` at the beginning of each query
- Filters output files to only include those created after `query_start_time`
- Uses `os.path.getctime()` to check file creation timestamps

**Modified `refresh_file_list()` function:**
- Only marks files as AI-created if they were created during the current query
- Compares file creation time with `query_start_time`

#### 2. Agent-Level Tracking (`langgraph_agent.py`)

**Modified `_execute_file` method:**
- Tracks execution start time for each file execution
- Only includes files created during the current execution session
- Provides detailed debug logging for file creation timing

### Frontend Changes

#### 1. Updated Display Header (`output-display.component.html`)

**Changed header text:**
```html
<h5>Generated Files (Current Query):</h5>
```

**Added no-files message:**
```html
<div *ngIf="result.outputFiles && result.outputFiles.length === 0 && (result.output || result.error)" class="no-files-message">
  <p><em>No new files were generated during this query.</em></p>
</div>
```

#### 2. Enhanced Styling (`output-display.component.css`)

**Added styling for no-files message:**
```css
.no-files-message {
  margin: 15px 0;
  padding: 10px;
  background-color: #e9ecef;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  text-align: center;
}
```

## How It Works

### 1. Query Start Tracking
When a user sends a message:
1. `query_start_time` is set to the current timestamp
2. This timestamp is used as the reference point for all file filtering

### 2. File Creation Detection
When files are created during execution:
1. The system checks the file's creation timestamp using `os.path.getctime()`
2. Only files created after `query_start_time` are included
3. Files created before the query are filtered out

### 3. Frontend Display
The frontend now:
1. Shows "Generated Files (Current Query)" to clarify context
2. Displays a message when no files were generated
3. Only shows files that were actually created during the current query

## Benefits

### 1. **Clear Context**
- Users can immediately see which files were generated by their current request
- No confusion from files created in previous queries

### 2. **Accurate Feedback**
- The system provides accurate information about what was actually generated
- Users can trust that the files shown are relevant to their current query

### 3. **Better User Experience**
- Cleaner, more focused file display
- Clear indication when no files were generated
- Reduced cognitive load from irrelevant files

### 4. **Debugging Support**
- Detailed logging shows file creation timestamps
- Easy to track which files are being included/excluded
- Helps identify timing-related issues

## Technical Details

### File Creation Time Detection
```python
if query_start_time and os.path.exists(abs_path):
    file_creation_time = os.path.getctime(abs_path)
    if file_creation_time >= query_start_time:
        # Include file - created during current query
    else:
        # Exclude file - created before current query
```

### Fallback Handling
- If file creation time cannot be determined, files are included as a fallback
- This ensures no files are accidentally lost due to timing issues

### Cross-Platform Compatibility
- Uses `os.path.getctime()` which works on Windows, macOS, and Linux
- Handles different file system timestamp behaviors

## Testing

To test the implementation:

1. **Send a query that generates files** (e.g., "Create a visualization")
2. **Send an unrelated query** (e.g., "What tables are in the database?")
3. **Verify that only files from the first query appear** in the "Generated Files" window

The system should now only show files that were actually created during the current query, providing a much cleaner and more accurate user experience. 